---
updateTime: '2025-12-21 20:25'
tags: 读书小记
---
![](/minio/weblog/d602c620bb794e9d9989602a8af0392d.png)
## 一、衡量好的系统
### 可靠性
- 功能上
  - 对外承诺的基础功能
- 性能上
  - 几十到几百毫秒必须返回
- 安全上
  - 数据安全
如何保证可靠：chaosmonkeys（混沌工程测试）
MTTF(mean time to failure)
可伸缩性(系统应对负载增长的能力)
应对负载：纵向伸缩(单台更强)、横向伸缩(多台)
- 自动伸缩
  - 巡检
- 手动伸缩
- 半自动
无状态服务(网关直接路由过来即可)、有状态(服务需要考虑数据同步等等问题（diff）)
描述性能：吞吐(throughput)、RT、latency
可维护性
可维护、简洁、可演化(降低改变的门槛)
未完待续...



## 二、数据模型
文档（一对多）、关系、图（多对多）
命令式、声明式

## 三、数据编码
### 文本
- xml
- json
### 二进制
以下 最大的区别是**没有字段名**，而只有字段标签，即数字 1，2，3，就像别名
- protoBuf
- Hessian
- Thrift
  - BinaryProtocol
  -  CompactProtocol(将字段类型和标签号打包到一起、对数字压缩)
- Avro
## 四、事物
快照隔离
## 五、分布式
  - 中心化
  - 多主
    -  异地多话 （容灾范围： 城市/地区级故障）
      - 单元化架构(同一个用户写请求路由到一个单元、同步到其它单元)   （计算与存储同单元，延迟低）
    - 同城多活 （容灾范围：机房级故障）
      - 延迟低，可实现强一致 
  - 无主
  
注意：
冷备：备份全量数据，不承载业务流量
多活：多个数据中心都能独立提供服务能力，常态承载线上流量

### 时钟
- 单调钟 ： 开机到现在的时间，一定是单调递增的
- 日历时钟 ：
  - 通常与网络时间协议（NTP）同步 ，不能保证单调递增
  - **时钟回播解决**：记录前一次ID，抛异常，等待,切换workerID,提前备一些id
### 一致性
#### 顺序一致性(ZAB)
  - 会存在读到旧数据的情况
#### 线性一致性(Raft)
  - Follower读之前必须向Leader确认当前最新的已提交的日志索引，如果落后，必须先同步



纪元号(任期)防止脑裂
**全序广播**：只能保证所有从节点的数据顺序是一致的
线性一致性是新鲜性的保证：读取一定能看见**最新的写入值**。
实现：读取前，插入一条数据(触发sync)，并等待这条数据读取成功。

#### 实现自增：
**严格递增**：收到6，一定要看到5，才能插入
**非严格递增**(时间戳)：携带preId，一定要看到preId

### 两阶段提交
- 一旦有分支事物提交，他是**不可撤回**的，如果别的事物没有收到提交消息，需要**超时自动提交**
- 协调者故障
> 协调者必须把根据所有参与者得出的决定**写到磁盘上的事务日志**中，如果它随后就崩溃，恢复后也能知道自己所做的决定。这被称为提交点（commit point）。

### 三阶段提交
- 引入预盘寻阶段

## 六、存储结构
SSTable、LSMTree
## 七、分区
- hash
- range
- 可枚举散列值
## 八、批处理
 一般是同时处理所有用户的数据（全表扫描），而非某个特定用户的数据


## 九、流处理
很多数据是无界限的，因为它随着时间的推移而逐渐到达，如用户行为

